# 图片系统设计方案

## 1. 现状分析
目前的系统已经实现了一个基础的图片上传和展示功能：
- **存储**: 本地文件系统 (`public/uploads`)。
- **数据库**: `Post` 与 `PostImage` 一对多关联。
- **展示**: 前端实现了九宫格展示和 Lightbox 大图查看。
- **API**: `/api/upload` 处理文件写入，`/api/uploads/[filename]` 提供访问。

## 2. 现有方案的局限性
- **扩展性差**: 图片存储在应用服务器本地，无法横向扩展（多台服务器无法共享图片）。
- **性能瓶颈**: Node.js 处理静态文件不如 Nginx 或 CDN 高效。
- **持久化风险**: 容器化部署或重新部署时，如果未挂载持久卷，图片可能会丢失。
- **缺乏优化**: 没有图片压缩、裁剪功能，大图直接加载消耗带宽。

## 3. 改进方案构思 (建议)

### 3.1 存储层升级 (推荐)
将图片存储迁移到对象存储服务 (Object Storage)。
- **选项**: 阿里云 OSS, AWS S3, MinIO (自建)。
- **优势**: 高可用、无限容量、不仅限于单机。
- **CDN**: 配合 CDN 加速图片分发。

### 3.2 图片处理优化
- **压缩**: 上传前或上传后进行压缩 (使用 `sharp` 库)。
- **缩略图**: 生成不同尺寸的图片（列表页用小图，详情页用大图）。
- **格式转换**: 转换为 WebP 等现代格式以减小体积。

### 3.3 安全性增强
- **文件校验**: 验证文件魔数 (Magic Number) 而不仅仅是扩展名。
- **大小限制**: 严格限制上传文件大小 (如 5MB)。
- **访问控制**: 私有桶 + 签名 URL (如果需要私有图片)。

### 3.4 用户体验优化
- **上传进度条**: 显示上传进度。
- **拖拽上传**: 支持拖拽文件到发布框。
- **粘贴上传**: 支持从剪贴板粘贴图片。

## 4. 实施路线图

### 第一阶段：完善现有本地存储方案 (Current)
- [x] 基础上传与展示
- [ ] 添加图片大小限制与类型校验 (后端)
- [ ] 添加上传加载状态 (前端已由 `isUploading` 处理)

### 第二阶段：引入图片处理
- [ ] 引入 `sharp` 库
- [ ] 上传时自动压缩/转换为 WebP
- [ ] 生成缩略图

### 第三阶段：迁移至对象存储 (Cloud)
- [ ] 配置 OSS/S3 SDK
- [ ] 修改 `/api/upload` 逻辑，上传至云端
- [ ] 数据迁移 (旧图片迁移)

## 5. 架构图 (目标)

```mermaid
graph TD
    Client[客户端] -->|上传图片| Server[Next.js API]
    Server -->|校验 & 压缩| Processor[图片处理器]
    Processor -->|存储| OSS[对象存储 (OSS/S3)]
    OSS -->|分发| CDN[内容分发网络]
    Client -->|读取图片| CDN
```
